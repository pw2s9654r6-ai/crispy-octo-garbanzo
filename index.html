<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Focus Timer</title>
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Focus Timer&quot;,&quot;short_name&quot;:&quot;Focus&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#F2F2F7&quot;,&quot;theme_color&quot;:&quot;#F2F2F7&quot;}">
<style>
:root{
  --bg:#F2F2F7;
  --text:#1C1C1E;
  --sub:#8E8E93;
  --accent:#6BD38A;
}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
  background:var(--bg);
  color:var(--text);
  text-align:center;
}
.screen{display:none;padding:20px;}
.active{display:block;}
h1{font-size:20px;margin:10px 0;}
.timer{
  width:220px;height:220px;margin:40px auto;position:relative;
}
svg{transform:rotate(-90deg);}
circle{
  fill:none;stroke-width:10;
}
.bg{stroke:#E5E5EA;}
.progress{
  stroke:var(--accent);
  stroke-linecap:round;
  transition:stroke-dashoffset 0.2s linear;
}
.time-text{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  font-size:42px;font-weight:600;
}
button{
  width:80%;height:56px;margin:10px auto;
  border:none;border-radius:999px;
  font-size:17px;font-weight:500;
}
.primary{background:var(--accent);color:white;}
.secondary{background:#E5E5EA;color:var(--text);}
.small{width:60%;}
.tabbar{
  position:fixed;bottom:0;width:100%;
  display:flex;background:white;border-top:1px solid #ddd;
}
.tabbar button{
  flex:1;height:50px;border-radius:0;background:white;
}
.tabbar button.activeTab{
  color:var(--accent);font-weight:600;
}
input{
  width:80%;height:44px;margin-top:20px;
  border-radius:12px;border:1px solid #ddd;
  padding:0 12px;font-size:16px;
}
.list{margin-top:20px;text-align:left;}
.list-item{
  padding:10px;border-bottom:1px solid #ddd;
}
.faded{color:var(--sub);}
.confetti{
  position:fixed;top:0;left:0;width:100%;height:100%;
  pointer-events:none;overflow:hidden;
}
.confetti span{
  position:absolute;width:8px;height:8px;
  background:var(--accent);animation:fall 0.8s linear forwards;
}
@keyframes fall{
  to{transform:translateY(100vh);opacity:0;}
}
</style>
</head>
<body>

<div id="timerScreen" class="screen active">
  <h1 id="todayTotal"></h1>
  <input id="titleInput" placeholder="今日の作業タイトル">
  <div class="timer">
    <svg width="220" height="220">
      <circle class="bg" cx="110" cy="110" r="100"></circle>
      <circle class="progress" cx="110" cy="110" r="100"
        stroke-dasharray="628" stroke-dashoffset="0"></circle>
    </svg>
    <div class="time-text" id="timeDisplay">01:00</div>
  </div>
  <button id="mainBtn" class="primary">1分集中スタート</button>
  <button id="continueBtn" class="primary" style="display:none;">続行</button>
  <button id="endBtn" class="secondary" style="display:none;">終了</button>
  <button id="pauseBtn" class="secondary" style="display:none;">中断</button>
  <button id="completeBtn" class="primary" style="display:none;">作業完了</button>
</div>

<div id="recordScreen" class="screen">
  <h1>記録</h1>
  <div id="recordList" class="list"></div>
</div>

<div id="calendarScreen" class="screen">
  <h1>カレンダー（月表示）</h1>
  <div id="calendar"></div>
</div>

<div class="tabbar">
  <button onclick="switchTab('timer')" class="activeTab">タイマー</button>
  <button onclick="switchTab('record')">記録</button>
  <button onclick="switchTab('calendar')">カレンダー</button>
</div>

<div id="confetti" class="confetti"></div>

<script>
let mode="idle";
let startTime=null;
let timerInterval=null;
let focusDuration=60;
let circle=document.querySelector(".progress");
let circumference=628;

function switchTab(tab){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".tabbar button").forEach(b=>b.classList.remove("activeTab"));
  if(tab==="timer"){
    timerScreen.classList.add("active");
    document.querySelectorAll(".tabbar button")[0].classList.add("activeTab");
  }
  if(tab==="record"){
    recordScreen.classList.add("active");
    document.querySelectorAll(".tabbar button")[1].classList.add("activeTab");
    loadRecords();
  }
  if(tab==="calendar"){
    calendarScreen.classList.add("active");
    document.querySelectorAll(".tabbar button")[2].classList.add("activeTab");
    loadCalendar();
  }
}

function playBeep(){
  let ctx=new (window.AudioContext||window.webkitAudioContext)();
  for(let i=0;i<4;i++){
    let osc=ctx.createOscillator();
    let gain=ctx.createGain();
    osc.type="square";
    osc.frequency.value=800;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start(ctx.currentTime+i*0.2);
    osc.stop(ctx.currentTime+i*0.2+0.1);
  }
}

function formatTime(sec){
  let m=Math.floor(sec/60);
  let s=sec%60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}

mainBtn.onclick=function(){
  mode="focus";
  let remaining=focusDuration;
  timeDisplay.textContent=formatTime(remaining);
  mainBtn.style.display="none";
  continueBtn.style.display="none";
  endBtn.style.display="none";
  timerInterval=setInterval(()=>{
    remaining--;
    timeDisplay.textContent=formatTime(remaining);
    circle.style.strokeDashoffset=circumference*(1-remaining/focusDuration);
    if(remaining<=0){
      clearInterval(timerInterval);
      playBeep();
      continueBtn.style.display="block";
      endBtn.style.display="block";
    }
  },1000);
};

continueBtn.onclick=function(){
  startWork();
};
endBtn.onclick=function(){
  reset();
};

function startWork(){
  mode="work";
  continueBtn.style.display="none";
  endBtn.style.display="none";
  pauseBtn.style.display="block";
  completeBtn.style.display="block";
  startTime=Date.now();
  timerInterval=setInterval(()=>{
    let elapsed=Math.floor((Date.now()-startTime)/1000);
    timeDisplay.textContent=formatTime(elapsed);
  },1000);
}

pauseBtn.onclick=function(){
  saveSession(false);
  reset();
};

completeBtn.onclick=function(){
  saveSession(true);
  launchConfetti();
  reset();
};

function reset(){
  clearInterval(timerInterval);
  mode="idle";
  mainBtn.style.display="block";
  pauseBtn.style.display="none";
  completeBtn.style.display="none";
  continueBtn.style.display="none";
  endBtn.style.display="none";
  circle.style.strokeDashoffset=0;
  timeDisplay.textContent="01:00";
}

function getWorkDate(){
  let now=new Date();
  now.setHours(now.getHours()-5);
  return now.toISOString().split("T")[0];
}

function saveSession(done){
  let title=titleInput.value||"無題";
  let elapsed=Math.floor((Date.now()-startTime)/1000);
  let data=JSON.parse(localStorage.getItem("records")||"[]");
  data.push({
    title:title,
    date:getWorkDate(),
    duration:elapsed,
    done:done
  });
  localStorage.setItem("records",JSON.stringify(data));
}

function loadRecords(){
  let data=JSON.parse(localStorage.getItem("records")||"[]");
  recordList.innerHTML="";
  data.slice().reverse().forEach(r=>{
    let div=document.createElement("div");
    div.className="list-item"+(r.done?"":" faded");
    div.textContent=r.date+" "+r.title+" "+formatTime(r.duration);
    recordList.appendChild(div);
  });
}

function loadCalendar(){
  let data=JSON.parse(localStorage.getItem("records")||"[]");
  let summary={};
  data.forEach(r=>{
    if(!summary[r.date])summary[r.date]=0;
    summary[r.date]+=r.duration;
  });
  calendar.innerHTML="";
  Object.keys(summary).sort().reverse().forEach(d=>{
    let div=document.createElement("div");
    div.className="list-item";
    div.textContent=d+" 合計 "+formatTime(summary[d]);
    calendar.appendChild(div);
  });
}

function launchConfetti(){
  for(let i=0;i<30;i++){
    let span=document.createElement("span");
    span.style.left=Math.random()*100+"%";
    span.style.background=`hsl(${Math.random()*360},70%,70%)`;
    confetti.appendChild(span);
    setTimeout(()=>span.remove(),800);
  }
}
</script>
</body>
</html>
